# BUPT_warm_DNSrelay
# Warm DNS - DNS 中继服务器

这是一个用 C 语言实现的轻量级 DNS 中继服务器，专为 Windows 平台设计。它接收本地 DNS 查询，并通过缓存、本地解析记录和向上游 DNS 服务器转发来提供响应。

该项目旨在提供一个可定制的、高性能的 DNS 解析方案，特别适用于需要域名过滤或内部域名解析的场景。

## 主要功能

- **DNS 查询中继**：接收客户端的 DNS 查询请求，并将其转发到指定的上游 DNS 服务器（默认为 `10.3.9.6`）。
- **LRU 缓存**：实现了一个基于双向链表的 LRU (Least Recently Used) 缓存机制，以加速对频繁访问的域名的解析。
- **域名过滤/重定向**：使用 **Trie 树** 数据结构从 `dnsrelay.txt` 文件中加载本地解析记录。
    - 可以为特定域名指定一个 IP 地址。
    - 当 IP 地址为 `0.0.0.0` 时，该域名将被拦截，服务器会向客户端返回 `NXDOMAIN`（域名不存在）错误，从而达到屏蔽网站的效果。
- **ID 映射**：在将请求转发到上游服务器时，为每个查询分配一个新的事务 ID，并维护一个映射表。这确保了来自上游的响应能够准确地路由回原始的客户端。
- **持久化**：成功从上游服务器获取到的 IPv4 解析结果会自动更新到 `dnsrelay.txt` 文件中，实现解析记录的持久化。
- **命令行配置**：支持通过命令行参数自定义服务器端口、缓存大小和调试级别。
- **调试日志**：提供两种级别的调试模式（`-d` 和 `-dd`），用于输出详细的请求和响应信息。

## 项目结构

```text
warm_DNS/
├── include/
│   ├── cache.h      # 缓存模块头文件
│   ├── dns.h        # DNS 协议及处理函数头文件
│   └── trie.h       # Trie 树模块头文件
├── src/
│   ├── cache.c      # 缓存模块实现 (LRU)
│   ├── dns.c        # DNS 报文解析、构建和处理
│   ├── main.c       # 程序主入口、套接字处理和主循环
│   └── trie.c       # Trie 树实现，用于域名匹配
├── dnsrelay.txt     # 本地域名解析和拦截配置文件
└── warm_DNS.exe     # (编译后生成的可执行文件)
```

## 环境要求

- Windows 操作系统
- GCC 编译器（例如 [MinGW-w64](https://www.mingw-w64.org/)）

## 编译

打开终端（如 CMD、PowerShell 或 Git Bash），导航到项目的根目录，然后执行以下命令：

```bash
gcc -o warm_DNS.exe src/main.c src/dns.c src/cache.c src/trie.c -I include -lws2_32
```

- `gcc`：调用 C 编译器。
- `-o warm_DNS.exe`：指定输出的可执行文件名为 `warm_DNS.exe`。
- `src/*.c`：包含所有源文件。
- `-I include`：将 `include` 目录添加到头文件搜索路径中。
- `-lws2_32`：链接 Windows Socket 2.2 库，这是进行网络编程所必需的。

## 配置

服务器的行为可以通过 `dnsrelay.txt` 文件进行配置。此文件用于定义本地的 DNS 解析规则。

- **格式**：每行包含一个域名和一个 IPv4 地址，用空格隔开。
- **域名拦截**：当 IP 地址为 `0.0.0.0` 时，匹配该域名的查询将被拦截。
- **域名重定向**：当 IP 地址为其他有效 IP 时，匹配该域名的查询将直接返回此 IP。

**`dnsrelay.txt` 示例：**

```text
# 将 a.com 解析到本地地址
a.com. 127.0.0.1

# 拦截（屏蔽）不良网站
blocked-site.com. 0.0.0.0

# 将公司内部服务指向特定 IP
internal-service.my-corp.com. 192.168.1.100
```

## 运行与使用

编译成功后，在终端中运行可执行文件。

**基本运行（使用默认配置）：**

```bash
./warm_DNS.exe
```

默认监听 `53` 端口，缓存大小为 `1000`。

**命令行参数：**

- `-p <端口号>`：指定服务器监听的端口。
    ```bash
    ./warm_DNS.exe -p 5353
    ```
- `-c <大小>`：指定缓存的条目数量。
    ```bash
    ./warm_DNS.exe -c 500
    ```
- `-d`：启用基本调试模式，输出简化的日志信息。
    ```bash
    ./warm_DNS.exe -d
    ```
- `-dd`：启用详细调试模式，输出完整的 DNS 报文信息。
    ```bash
    ./warm_DNS.exe -dd
    ```
- **组合使用：**
    ```bash
    ./warm_DNS.exe -p 5353 -c 500 -dd
    ```

运行后，将您的操作系统的 DNS 服务器地址设置为 `127.0.0.1`（如果服务器在本机运行），即可开始使用。

## 工作流程

对于每一个接收到的 DNS 查询，服务器按以下顺序处理：

1. **接收请求**：服务器在指定端口监听 UDP 数据包，接收来自客户端的 DNS 查询。
2. **Trie 树查询（本地/拦截）**：
    - 服务器首先在内存中的 Trie 树中查找请求的域名。该树在启动时由 `dnsrelay.txt` 文件构建。
    - **命中 `0.0.0.0`**：如果找到匹配项且其 IP 为 `0.0.0.0`，服务器立即构造一个 `NXDOMAIN` (域名不存在) 响应并发送给客户端。请求处理结束。
    - **命中其他 IP**：如果找到匹配项且为其他 IP，服务器直接使用该 IP 构建一个成功的 DNS 响应并发送给客户端。请求处理结束。
3. **缓存查询（LRU）**：
    - 如果 Trie 树未命中，服务器接着查询 LRU 缓存。
    - **缓存命中**：如果在缓存中找到未过期的记录，服务器使用缓存的 IP 地址构建响应并发送给客户端。被访问的缓存条目会被移动到链表头部。请求处理结束。
4. **转发至上游服务器**：
    - 如果 Trie 树和缓存均未命中，服务器将该请求转发到预设的上游 DNS 服务器。
    - 在转发前，会为该查询生成一个新的事务 ID，并保存原始客户端地址和原始 ID 的映射关系。
5. **处理并响应**：
    - 服务器等待上游服务器的响应。
    - 收到响应后，通过事务 ID 找到原始客户端信息，并将响应中的事务 ID 恢复为原始 ID。
    - 如果响应是成功的 A 记录（IPv4），则将该域名和 IP 的映射关系更新到缓存和 `dnsrelay.txt` 文件中。
    - 最后，将来自上游服务器的响应转发给原始客户端。
